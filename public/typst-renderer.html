<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typst Renderer</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #app { width: 100%; height: auto; }
        svg { width: 100%; height: auto; display: block; }
    </style>
</head>
<body>
    <div id="app"></div>
    <script type="module">
        // Import from CDN
        import { $typst } from 'https://unpkg.com/@myriaddreamin/typst.ts@0.5.0-rc5/dist/esm/contrib/snippet.mjs';

        let isReady = false;

        // Initialize
        async function init() {
            try {
                // The snippet module handles initialization automatically usually, 
                // but we might need to wait or trigger it.
                // For this specific module, it exposes $typst which has svg() method.
                isReady = true;
                window.parent.postMessage({ type: 'READY' }, '*');
            } catch (e) {
                console.error("Typst init error:", e);
                window.parent.postMessage({ type: 'ERROR', error: e.message }, '*');
            }
        }

        init();

        window.addEventListener('message', async (event) => {
            if (event.data.type === 'RENDER' && isReady) {
                try {
                    const content = event.data.content;
                    // Render to SVG
                    const svg = await $typst.svg({ mainContent: content });
                    document.getElementById('app').innerHTML = svg;
                    
                    // Send height back to parent for resizing
                    const height = document.getElementById('app').scrollHeight;
                    window.parent.postMessage({ type: 'RESIZE', height }, '*');
                } catch (e) {
                    console.error("Render error:", e);
                    document.getElementById('app').innerText = "Error rendering Typst content: " + e.message;
                }
            }
        });
    </script>
</body>
</html>
